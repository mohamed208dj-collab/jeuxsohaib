<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X-O Infinite Quantum Nexus</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Orbitron:wght@500;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --player-x-color: #00e5ff; /* Cyan */
            --player-o-color: #ff00ea; /* Magenta */
            --win-color: #ffcc00; /* Gold */
            --bg-deep: #000a12;
            --card-glass: rgba(10, 20, 30, 0.8);
            --border-glow: rgba(0, 229, 255, 0.3);
            --terminal-text: #00ff7f; /* Bright green for log */
        }

        body {
            margin: 0;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--bg-deep);
            font-family: 'Cairo', sans-serif;
            color: white;
            overflow: hidden;
            perspective: 2000px; /* لتمكين 3D بشكل أعمق */
        }

        /* خلفية الكوكب والنجوم المتحركة */
        .cosmic-background {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: radial-gradient(circle at 50% 50%, #1a0a30 0%, #000a12 100%);
            overflow: hidden;
            z-index: -1;
        }
        .planet {
            position: absolute;
            width: 800px; height: 800px;
            background: radial-gradient(circle at 30% 30%, #4a0e88, #1a0a30);
            border-radius: 50%;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) rotateX(60deg);
            box-shadow: 0 0 200px rgba(74, 14, 136, 0.5);
            animation: planet-rotate 40s linear infinite;
        }
        @keyframes planet-rotate {
            from { transform: translate(-50%, -50%) rotateX(60deg) rotateZ(0deg); }
            to { transform: translate(-50%, -50%) rotateX(60deg) rotateZ(360deg); }
        }
        .star-field {
            position: absolute;
            width: 2000px; height: 2000px;
            background-image: radial-gradient(white 1px, transparent 1px);
            background-size: 50px 50px;
            animation: stars-move 100s linear infinite;
        }
        @keyframes stars-move {
            from { transform: translate(0,0); }
            to { transform: translate(-2000px, -2000px); }
        }


        .game-console {
            position: relative;
            z-index: 10;
            width: 95%;
            max-width: 500px;
            transform-style: preserve-3d;
            transition: transform 0.1s ease-out; /* لتاثير الميلان 3D */
        }

        .console-panel {
            background: var(--card-glass);
            backdrop-filter: blur(35px);
            border-radius: 30px;
            padding: 40px;
            border: 2px solid var(--border-glow);
            box-shadow: 0 0 100px rgba(0,0,0,0.8), inset 0 0 50px rgba(0, 229, 255, 0.2);
            text-align: center;
            position: relative;
        }

        .console-panel::before { /* تأثير وهج الحدود المتحرك */
            content: '';
            position: absolute;
            inset: -5px;
            border-radius: 35px;
            background: linear-gradient(45deg, transparent, var(--player-x-color), var(--player-o-color), transparent);
            filter: blur(20px);
            opacity: 0.7;
            animation: border-glow 10s linear infinite;
            z-index: -1;
        }
        @keyframes border-glow {
            0% { transform: scale(1) rotate(0deg); }
            100% { transform: scale(1.02) rotate(360deg); }
        }

        header h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 3.5rem;
            margin: 0 0 15px;
            background: linear-gradient(to right, var(--player-x-color), var(--player-o-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 40px var(--player-x-color);
            letter-spacing: 2px;
        }

        .terminal-log {
            min-height: 40px;
            background: rgba(0,0,0,0.6);
            border: 1px solid var(--terminal-text);
            border-radius: 10px;
            padding: 10px 15px;
            margin-bottom: 25px;
            font-family: 'Orbitron', monospace;
            font-size: 0.9rem;
            color: var(--terminal-text);
            text-align: left;
            overflow: hidden;
            white-space: nowrap;
        }

        .stats-display {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 30px;
            font-family: 'Orbitron', sans-serif;
        }
        .stat-unit {
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            text-shadow: 0 0 10px rgba(255,255,255,0.2);
        }
        .stat-unit h4 { margin: 0; font-size: 0.8rem; opacity: 0.7; }
        .stat-unit p { margin: 5px 0 0; font-size: 1.5rem; font-weight: 900; }
        .stat-x p { color: var(--player-x-color); }
        .stat-o p { color: var(--player-o-color); }
        .stat-draw p { color: #aaa; }


        /* 3D Board */
        .board-3d {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 30px;
            transform-style: preserve-3d;
        }

        .cube-cell {
            aspect-ratio: 1;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.08);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            font-family: 'Orbitron';
            cursor: pointer;
            transition: transform 0.3s ease-out, background 0.3s, border-color 0.3s;
            transform-style: preserve-3d;
            transform: rotateX(0deg) rotateY(0deg) translateZ(0px); /* Default 3D */
            position: relative;
        }

        .cube-cell:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--player-x-color); /* يتغير حسب اللاعب */
            transform: translateZ(30px) scale(1.05);
            box-shadow: 0 0 30px var(--player-x-color);
        }

        .cube-cell .content {
            transform: translateZ(20px); /* لجعل المحتوى يبرز أكثر */
            transition: transform 0.3s;
        }

        .cube-cell.x .content { color: var(--player-x-color); text-shadow: 0 0 35px var(--player-x-color); }
        .cube-cell.o .content { color: var(--player-o-color); text-shadow: 0 0 35px var(--player-o-color); }

        .cube-cell.winner-fx {
            background: var(--win-color) !important;
            color: black !important;
            text-shadow: none;
            box-shadow: 0 0 80px var(--win-color);
            transform: translateZ(80px) scale(1.2) rotateY(360deg);
            animation: winner-pulse 1s infinite alternate;
        }
        @keyframes winner-pulse {
            from { box-shadow: 0 0 80px var(--win-color); }
            to { box-shadow: 0 0 120px var(--win-color), 0 0 40px var(--win-color); }
        }

        /* Controls */
        .control-panel {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        .control-btn {
            background: var(--player-x-color);
            color: var(--bg-deep);
            padding: 15px 30px;
            border-radius: 15px;
            font-weight: 900;
            border: none;
            cursor: pointer;
            transition: 0.3s;
            font-family: 'Cairo';
            box-shadow: 0 0 20px var(--player-x-color);
        }
        .control-btn.secondary {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: none;
        }
        .control-btn:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 15px 30px rgba(0,0,0,0.6), 0 0 30px var(--player-x-color);
        }
        .control-btn.secondary:hover {
            box-shadow: 0 15px 30px rgba(0,0,0,0.6), 0 0 15px rgba(255,255,255,0.3);
        }

    </style>
</head>
<body>

<div class="cosmic-background">
    <div class="planet"></div>
    <div class="star-field"></div>
</div>

<div class="game-console" id="game-console">
    <div class="console-panel">
        <header>
            <h1>QUANTUM NEXUS</h1>
            <div class="terminal-log" id="terminal-log">
                &gt; [SYSTEM] Initializing Quantum Matrix...
            </div>
        </header>

        <div class="stats-display">
            <div class="stat-unit stat-x"><h4>PLAYER X</h4><p id="s-x">0</p></div>
            <div class="stat-unit stat-draw"><h4>DRAW</h4><p id="s-d">0</p></div>
            <div class="stat-unit stat-o"><h4>PLAYER O (AI)</h4><p id="s-o">0</p></div>
        </div>

        <div class="board-3d" id="board-3d">
            <div class="cube-cell" data-idx="0"><div class="content"></div></div>
            <div class="cube-cell" data-idx="1"><div class="content"></div></div>
            <div class="cube-cell" data-idx="2"><div class="content"></div></div>
            <div class="cube-cell" data-idx="3"><div class="content"></div></div>
            <div class="cube-cell" data-idx="4"><div class="content"></div></div>
            <div class="cube-cell" data-idx="5"><div class="content"></div></div>
            <div class="cube-cell" data-idx="6"><div class="content"></div></div>
            <div class="cube-cell" data-idx="7"><div class="content"></div></div>
            <div class="cube-cell" data-idx="8"><div class="content"></div></div>
        </div>

        <div class="control-panel">
            <button class="control-btn" onclick="resetGame()">RESET SYSTEM</button>
            <button class="control-btn secondary" id="mode-toggle" onclick="toggleMode()">AI: ON</button>
        </div>
    </div>
</div>

<script>
    // --- 3D Tilt Effect for Console ---
    const gameConsole = document.getElementById('game-console');
    document.addEventListener('mousemove', (e) => {
        const xAxis = (window.innerWidth / 2 - e.pageX) / 40; // Smaller rotation
        const yAxis = (window.innerHeight / 2 - e.pageY) / 40;
        gameConsole.style.transform = `rotateY(${xAxis}deg) rotateX(${-yAxis}deg)`;
    });

    // --- Game Logic ---
    let board = ["", "", "", "", "", "", "", "", ""];
    let currentPlayer = "X";
    let isGameActive = true;
    let vsAI = true;
    let scores = JSON.parse(localStorage.getItem('xo-quantum-scores')) || {X: 0, O: 0, D: 0};

    const cells = document.querySelectorAll('.cube-cell');
    const terminalLog = document.getElementById('terminal-log');
    
    // Initial UI update from localStorage
    updateUI();
    logMessage("[SYSTEM] Quantum Matrix Initialized. Awaiting Command...");

    function logMessage(msg) {
        terminalLog.innerHTML = `&gt; ${msg}`;
        // You can add more complex scrolling/typing effects here
    }

    function toggleMode() {
        vsAI = !vsAI;
        document.getElementById('mode-toggle').innerText = vsAI ? "AI: ON" : "AI: OFF (PVP)";
        logMessage(`[SYSTEM] AI Mode: ${vsAI ? 'ENABLED' : 'DISABLED'}.`);
        resetGame();
    }

    cells.forEach(cell => cell.addEventListener('click', (e) => {
        const idx = e.currentTarget.dataset.idx;
        if (board[idx] !== "" || !isGameActive) {
            logMessage("[ERROR] Invalid move. Cell occupied or game ended.");
            return;
        }

        makeMove(idx, currentPlayer);

        if (isGameActive && vsAI && currentPlayer === 'O') { // AI's turn
            logMessage("[AI] Calculating optimal strategy...");
            setTimeout(() => {
                const bestMove = getAIMove(board);
                makeMove(bestMove, "O");
            }, 800); // Simulate AI thinking
        }
    }));

    function makeMove(idx, player) {
        board[idx] = player;
        const cellContent = cells[idx].querySelector('.content');
        cellContent.innerText = player;
        cells[idx].classList.add(player.toLowerCase());
        logMessage(`[PLAYER ${player}] Moved to cell ${parseInt(idx) + 1}.`);

        // Change hover glow color based on next player
        document.documentElement.style.setProperty('--player-x-color', currentPlayer === 'X' ? '#00e5ff' : '#ff00ea');

        if (checkWin(board, player)) {
            endGame(player);
        } else if (!board.includes("")) {
            endGame('Draw');
        } else {
            currentPlayer = player === "X" ? "O" : "X";
            logMessage(`[SYSTEM] Current turn: PLAYER ${currentPlayer}.`);
        }
    }

    // Minimax Algorithm (Unbeatable AI)
    function getAIMove(currentBoard) {
        let bestMove = minimax(currentBoard, "O").index;
        return bestMove;
    }

    function minimax(newBoard, player) {
        const availSpots = newBoard.map((val, idx) => val === "" ? idx : null).filter(val => val !== null);

        if (checkWin(newBoard, "X")) return {score: -10};
        if (checkWin(newBoard, "O")) return {score: 10};
        if (availSpots.length === 0) return {score: 0};

        const moves = [];
        for (let i = 0; i < availSpots.length; i++) {
            const move = {};
            move.index = availSpots[i];
            newBoard[availSpots[i]] = player;

            if (player === "O") {
                move.score = minimax(newBoard, "X").score;
            } else {
                move.score = minimax(newBoard, "O").score;
            }

            newBoard[availSpots[i]] = ""; // Reset board after checking
            moves.push(move);
        }

        let bestMove;
        if (player === "O") {
            let bestScore = -Infinity;
            for (let i = 0; i < moves.length; i++) {
                if (moves[i].score > bestScore) {
                    bestScore = moves[i].score;
                    bestMove = i;
                }
            }
        } else { // player === "X"
            let bestScore = Infinity;
            for (let i = 0; i < moves.length; i++) {
                if (moves[i].score < bestScore) {
                    bestScore = moves[i].score;
                    bestMove = i;
                }
            }
        }
        return moves[bestMove];
    }

    function checkWin(b, p) {
        const patterns = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
        return patterns.some(pattern => {
            const win = pattern.every(idx => b[idx] === p);
            if (win && isGameActive && b === board) { // Apply winner effect only to active game board
                pattern.forEach(idx => cells[idx].classList.add('winner-fx'));
            }
            return win;
        });
    }

    function endGame(result) {
        isGameActive = false;
        if (result === 'Draw') {
            logMessage("[SYSTEM] Draw declared. No dominant force detected.");
            scores.D++;
        } else {
            logMessage(`[SYSTEM] PLAYER ${result} has achieved Quantum Dominance!`);
            scores[result]++;
            confetti({
                particleCount: 300,
                spread: 120,
                origin: { y: 0.6 },
                colors: [result === 'X' ? '#00e5ff' : '#ff00ea', '#ffcc00', '#ffffff']
            });
        }
        localStorage.setItem('xo-quantum-scores', JSON.stringify(scores));
        updateUI();
    }

    function updateUI() {
        document.getElementById('s-x').innerText = scores.X;
        document.getElementById('s-o').innerText = scores.O;
        document.getElementById('s-d').innerText = scores.D;
    }

    function resetGame() {
        board = ["", "", "", "", "", "", "", "", ""];
        isGameActive = true;
        currentPlayer = "X";
        logMessage("[SYSTEM] Matrix Reset. New game initiated.");
        cells.forEach(cell => {
            cell.querySelector('.content').innerText = "";
            cell.classList.remove('x', 'o', 'winner-fx');
        });
        document.documentElement.style.setProperty('--player-x-color', '#00e5ff'); // Reset hover glow
    }
</script>
</body>
</html>
