<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LOVE WHEEL | تحدي الحبيبين</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@700&family=Pacifico&display=swap" rel="stylesheet">
    <style>
        :root { --main-pink: #ff2e63; --soft-pink: #eaeaea; --bg: #1a080e; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Cairo', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; overflow: hidden; }
        
        .setup-box { background: rgba(255, 46, 99, 0.1); padding: 30px; border-radius: 20px; border: 1px solid var(--main-pink); text-align: center; width: 85%; }
        
        /* تصميم العجلة */
        .wheel-container { position: relative; width: 300px; height: 300px; border: 8px solid var(--main-pink); border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99); box-shadow: 0 0 30px var(--main-pink); }
        .wheel-center { width: 20px; height: 20px; background: white; border-radius: 50%; z-index: 10; position: absolute; }
        .arrow { width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-bottom: 30px solid white; position: absolute; top: -40px; z-index: 20; }

        .btn-spin { margin-top: 40px; padding: 15px 40px; background: var(--main-pink); border: none; border-radius: 50px; color: white; font-weight: bold; font-size: 1.2rem; cursor: pointer; box-shadow: 0 5px 15px rgba(255, 46, 99, 0.4); }
        .btn-spin:disabled { opacity: 0.5; }

        .result-box { margin-top: 20px; font-size: 1.3rem; color: #ffeb3b; text-align: center; min-height: 50px; padding: 0 20px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="setup" class="setup-box">
    <h1 style="font-family: 'Pacifico'; color: var(--main-pink);">Love Wheel</h1>
    <p>أدخلا كود الربط الخاص بكما</p>
    <input type="text" id="roomInput" style="width: 100%; padding: 12px; border-radius: 10px; border: none; text-align: center;" placeholder="مثلاً: love2024">
    <button class="btn-spin" style="margin-top: 20px;" onclick="connect()">دخول</button>
</div>

<div id="game" class="hidden" style="text-align: center;">
    <div class="arrow"></div>
    <div id="wheel" class="wheel-container">
        <div style="position: absolute; width: 100%; height: 2px; background: rgba(255,255,255,0.2); transform: rotate(45deg);"></div>
        <div style="position: absolute; width: 100%; height: 2px; background: rgba(255,255,255,0.2); transform: rotate(90deg);"></div>
        <div style="position: absolute; width: 100%; height: 2px; background: rgba(255,255,255,0.2); transform: rotate(135deg);"></div>
        <span style="font-size: 0.8rem; opacity: 0.5;">❤️ صراحة | جرأة | هدية ❤️</span>
    </div>
    
    <div id="result" class="result-box"></div>
    <button id="spinBtn" class="btn-spin" onclick="spin()">إبدأ الحظ</button>
    <p id="info" style="font-size: 0.7rem; opacity: 0.5; margin-top: 20px;"></p>
</div>

<script>
    // ⚠️ حط معلومات Supabase تاعك هنا
    const SB_URL = 'رابط_مشروعك';
    const SB_KEY = 'anon_key_تاعك';
    
    const supabase = exports.supabasejs.createClient(SB_URL, SB_KEY);
    let channel, roomId;
    
    // قائمة المهام
    const tasks = [
        "أوصف شريكك بكلمة واحدة",
        "ماهي أجمل ذكرى بينكما؟",
        "تحدي: أرسل صورة مضحكة الآن",
        "ما هو أكثر شيء تحبه في الطرف الآخر؟",
        "سؤال صراحة: متى كانت أول مرة أعجبت به؟",
        "تحدي: غني مقطع من أغنية رومانسية",
        "أطلب طلب من الطرف الآخر الآن"
    ];

    async function connect() {
        roomId = document.getElementById('roomInput').value;
        if(!roomId) return;

        channel = supabase.channel('love_' + roomId);
        channel
            .on('broadcast', { event: 'spin' }, (payload) => {
                applySpin(payload.payload.rotation, payload.payload.taskIndex);
            })
            .subscribe((status) => {
                if(status === 'SUBSCRIBED') {
                    document.getElementById('setup').classList.add('hidden');
                    document.getElementById('game').classList.remove('hidden');
                    document.getElementById('info').innerText = "تم الربط بنجاح ❤️";
                }
            });
    }

    function spin() {
        const rotation = Math.floor(Math.random() * 360) + 1440; // 4 دورات على الأقل
        const taskIndex = Math.floor(Math.random() * tasks.length);
        
        // إرسال للطرف الآخر
        channel.send({
            type: 'broadcast',
            event: 'spin',
            payload: { rotation, taskIndex }
        });

        applySpin(rotation, taskIndex);
    }

    function applySpin(deg, index) {
        const wheel = document.getElementById('wheel');
        const btn = document.getElementById('spinBtn');
        const result = document.getElementById('result');
        
        btn.disabled = true;
        result.innerText = "جاري الاختيار...";
        wheel.style.transform = `rotate(${deg}deg)`;

        setTimeout(() => {
            result.innerText = tasks[index];
            btn.disabled = false;
            // تصفير الزاوية برفق لضمان استمرار الدوران في المرات القادمة
            wheel.style.transition = 'none';
            wheel.style.transform = `rotate(${deg % 360}deg)`;
            setTimeout(() => wheel.style.transition = 'transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99)', 50);
        }, 4000);
    }
</script>
</body>
</html>
