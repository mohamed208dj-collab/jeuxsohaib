<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>X-O NEURAL SINGULARITY</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;900&family=Cairo:wght@600;900&display=swap" rel="stylesheet">
    <style>
        :root { --p1: #00f2fe; --p2: #fc00ff; --bg: #020205; --card: rgba(10, 10, 20, 0.7); }
        
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; outline: none; }
        
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100vh; 
            background: var(--bg); color: white; font-family: 'Cairo', sans-serif;
            overflow: hidden; display: flex; align-items: center; justify-content: center;
        }

        /* محرك الخلفية السائل */
        #bg-canvas { position: fixed; inset: 0; z-index: -1; filter: blur(30px); opacity: 0.5; }

        .container { width: 100%; max-width: 450px; padding: 15px; z-index: 10; transition: 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); }

        /* البطاقة الرئيسية بتأثير الزجاج */
        .glass-card {
            background: var(--card); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 40px;
            padding: 30px; box-shadow: 0 50px 100px rgba(0,0,0,0.8);
            position: relative; overflow: hidden;
        }

        .header { text-align: center; margin-bottom: 25px; }
        .header h1 { 
            font-family: 'Orbitron'; font-size: 2rem; margin: 0; letter-spacing: 4px;
            background: linear-gradient(90deg, var(--p1), var(--p2));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        .stats-bar {
            display: flex; justify-content: space-between; background: rgba(0,0,0,0.4);
            padding: 12px 20px; border-radius: 20px; margin-bottom: 20px;
            font-family: 'Orbitron'; font-size: 0.8rem; border: 1px solid rgba(255,255,255,0.05);
        }

        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        
        .cell {
            aspect-ratio: 1; background: rgba(255,255,255,0.03); border-radius: 22px;
            border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center;
            justify-content: center; font-size: 3.5rem; font-family: 'Orbitron';
            cursor: pointer; transition: 0.2s; position: relative;
        }
        
        .cell:hover { background: rgba(255,255,255,0.08); border-color: var(--p1); }
        .cell.x { color: var(--p1); text-shadow: 0 0 20px var(--p1); }
        .cell.o { color: var(--p2); text-shadow: 0 0 20px var(--p2); }
        .cell.win { background: white !important; color: black !important; transform: scale(1.05); z-index: 5; }

        /* شاشة الربط */
        .overlay {
            position: fixed; inset: 0; background: var(--bg); z-index: 1000;
            display: flex; align-items: center; justify-content: center; text-align: center;
            padding: 20px;
        }
        .setup-box { width: 100%; max-width: 380px; }
        .id-card {
            background: #0a0a15; border: 2px dashed #1a1a30; padding: 20px;
            border-radius: 30px; margin: 25px 0; cursor: pointer; transition: 0.3s;
        }
        .id-card:hover { border-color: var(--p1); background: #0e0e1e; }
        .id-card span { font-family: 'Orbitron'; font-size: 1.4rem; color: var(--p1); display: block; }

        input {
            width: 100%; padding: 18px; border-radius: 20px; border: 1px solid #222;
            background: #000; color: white; text-align: center; font-size: 1rem; margin-bottom: 15px;
        }
        .main-btn {
            width: 100%; padding: 18px; border-radius: 20px; border: none;
            background: linear-gradient(45deg, var(--p1), var(--p2));
            color: white; font-weight: 900; font-size: 1rem; cursor: pointer;
            box-shadow: 0 10px 20px rgba(0, 242, 254, 0.2);
        }

        .chat-input-zone { display: flex; gap: 10px; margin-top: 20px; }
        .chat-input-zone input { margin: 0; font-size: 0.8rem; padding: 12px; }

        .hidden { display: none !important; }

        /* تحسينات للهاتف */
        @media (max-width: 600px) {
            .cell { font-size: 2.8rem; border-radius: 18px; }
            .glass-card { padding: 20px; border-radius: 30px; }
        }
    </style>
</head>
<body>

<canvas id="bg-canvas"></canvas>

<div id="setup-screen" class="overlay">
    <div class="setup-box">
        <h1 style="font-family:'Orbitron'; letter-spacing:8px;">SINGULARITY</h1>
        <div class="id-card" onclick="copyMyID()">
            <p style="color:#555; margin:0; font-size:0.8rem;">كود جهازك (اضغط للنسخ)</p>
            <span id="my-peer-id">جاري التوليد...</span>
        </div>
        <input type="text" id="join-id" placeholder="أدخل كود صديقك">
        <button class="main-btn" onclick="startSync()">بدء المزامنة العصبية</button>
    </div>
</div>

<div class="container hidden" id="game-ui">
    <div class="glass-card">
        <div class="header">
            <h1>NEURAL X-O</h1>
        </div>

        <div class="stats-bar">
            <div id="p1-score">X: 0</div>
            <div id="latency" style="color:#555; font-size:0.6rem;">PING: 0ms</div>
            <div id="p2-score">O: 0</div>
        </div>

        <div id="status" style="text-align:center; font-family:'Orbitron'; font-size:0.7rem; color:var(--p1); margin-bottom:15px;">> STATUS: ONLINE</div>

        <div class="grid" id="board-grid">
            <div class="cell" data-i="0"></div><div class="cell" data-i="1"></div><div class="cell" data-i="2"></div>
            <div class="cell" data-i="3"></div><div class="cell" data-i="4"></div><div class="cell" data-i="5"></div>
            <div class="cell" data-i="6"></div><div class="cell" data-i="7"></div><div class="cell" data-i="8"></div>
        </div>

        <div class="chat-input-zone">
            <input type="text" id="chat-msg" placeholder="أرسل رسالة سريعة...">
            <button onclick="sendQuickMsg()" style="background:none; border:1px solid #333; color:white; border-radius:12px; padding:0 15px; cursor:pointer;">✉</button>
        </div>
    </div>
</div>

<script>
    const peer = new Peer();
    let conn, mySym = "", board = Array(9).fill(""), turn = "X", active = true;
    let scores = {X: 0, O: 0};

    // محرك الخلفية السائل (Canvas Liquid)
    const canvas = document.getElementById('bg-canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    let points = [];
    for(let i=0; i<5; i++) points.push({x: Math.random()*canvas.width, y: Math.random()*canvas.height, vx: Math.random()*2-1, vy: Math.random()*2-1, r: Math.random()*150+100});

    function drawBg() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        points.forEach(p => {
            p.x += p.vx; p.y += p.vy;
            if(p.x < 0 || p.x > canvas.width) p.vx *= -1;
            if(p.y < 0 || p.y > canvas.height) p.vy *= -1;
            let grad = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.r);
            grad.addColorStop(0, Math.random() > 0.5 ? 'rgba(0, 242, 254, 0.4)' : 'rgba(252, 0, 255, 0.4)');
            grad.addColorStop(1, 'transparent');
            ctx.fillStyle = grad; ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); ctx.fill();
        });
        requestAnimationFrame(drawBg);
    }
    drawBg();

    peer.on('open', id => document.getElementById('my-peer-id').innerText = id);

    function copyMyID() {
        navigator.clipboard.writeText(document.getElementById('my-peer-id').innerText);
        alert("تم النسخ! ابعثوا لصاحبك");
    }

    peer.on('connection', c => { conn = c; mySym = "X"; setupGame(); });

    function startSync() {
        const tid = document.getElementById('join-id').value;
        if(!tid) return;
        conn = peer.connect(tid);
        mySym = "O";
        conn.on('open', setupGame);
    }

    function setupGame() {
        document.getElementById('setup-screen').classList.add('hidden');
        document.getElementById('game-ui').classList.remove('hidden');
        updateStatus();

        conn.on('data', data => {
            if(data.type === 'move') syncMove(data.i, data.p);
            if(data.type === 'chat') alert("خصمك: " + data.m);
            if(data.type === 'ping') conn.send({type: 'pong', t: data.t});
            if(data.type === 'pong') document.getElementById('latency').innerText = `PING: ${Date.now() - data.t}ms`;
        });

        setInterval(() => { if(conn) conn.send({type: 'ping', t: Date.now()}); }, 2000);
    }

    document.querySelectorAll('.cell').forEach(cell => {
        cell.onclick = () => {
            const i = cell.dataset.i;
            if(board[i] || turn !== mySym || !active) return;
            syncMove(i, mySym);
            conn.send({type: 'move', i: i, p: mySym});
            if (window.navigator.vibrate) window.navigator.vibrate(20);
        };
    });

    function syncMove(i, p) {
        board[i] = p;
        const el = document.querySelector(`[data-i="${i}"]`);
        el.innerText = p; el.classList.add(p.toLowerCase());
        
        if(checkWin(p)) {
            scores[p]++;
            end(p);
        } else if(!board.includes("")) {
            end("D");
        } else {
            turn = turn === "X" ? "O" : "X";
            updateStatus();
        }
    }

    function updateStatus() {
        document.getElementById('p1-score').innerText = `X: ${scores.X}`;
        document.getElementById('p2-score').innerText = `O: ${scores.O}`;
        document.getElementById('status').innerText = turn === mySym ? "> YOUR TURN" : "> PEER TURN";
        document.getElementById('status').style.color = turn === 'X' ? 'var(--p1)' : 'var(--p2)';
    }

    function checkWin(p) {
        const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
        return wins.some(w => {
            const isWin = w.every(idx => board[idx] === p);
            if(isWin) w.forEach(idx => document.querySelector(`[data-i="${idx}"]`).classList.add('win'));
            return isWin;
        });
    }

    function end(res) {
        active = false;
        if(res !== 'D') confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        document.getElementById('status').innerText = res === 'D' ? "> DRAW" : `> ${res} WON!`;
        setTimeout(() => {
            board.fill(""); active = true; turn = "X";
            document.querySelectorAll('.cell').forEach(c => { c.innerText = ""; c.className = "cell"; });
            updateStatus();
        }, 4000);
    }

    function sendQuickMsg() {
        const m = document.getElementById('chat-msg').value;
        if(m && conn) { conn.send({type: 'chat', m: m}); document.getElementById('chat-msg').value = ""; }
    }
</script>
</body>
</html>
