<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>X-O Quantum Online Edition</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@700;900&family=Orbitron:wght@600;900&display=swap" rel="stylesheet">
    <style>
        :root { --cyan: #00f2fe; --pink: #fc00ff; --bg: #020205; }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background: var(--bg); font-family: 'Cairo', sans-serif; 
            display: flex; align-items: center; justify-content: center; overflow: hidden;
        }

        /* Ø®Ù„ÙÙŠØ© Ø³Ø¯ÙŠÙ…ÙŠØ© ÙØ®Ù…Ø© */
        .nebula {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #1b0c47 0%, #020205 100%);
            z-index: -1;
        }
        .nebula::after {
            content: ''; position: absolute; width: 200%; height: 200%; top: -50%; left: -50%;
            background: radial-gradient(circle at 20% 30%, rgba(0, 242, 254, 0.1), transparent 40%);
            animation: rotate 30s infinite linear; filter: blur(60px);
        }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* Ø§Ù„Ø´Ø§Ø´Ø§Øª */
        .overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 100; backdrop-filter: blur(10px); padding: 20px; text-align: center;
        }

        .card {
            background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(20px);
            border-radius: 30px; border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 25px; width: 90%; max-width: 420px; box-shadow: 0 30px 60px rgba(0,0,0,0.5);
        }

        h1 { font-family: 'Orbitron'; font-size: clamp(1.8rem, 8vw, 2.5rem); margin: 0 0 15px; color: #fff; letter-spacing: 5px; }

        .id-display {
            background: rgba(255,255,255,0.05); border: 1px dashed var(--cyan);
            padding: 15px; border-radius: 15px; margin: 20px 0; cursor: pointer;
        }
        .id-display span { font-family: 'Orbitron'; color: var(--cyan); font-size: 1.2rem; display: block; }

        .status { 
            background: rgba(0,0,0,0.3); padding: 10px; border-radius: 12px;
            margin-bottom: 15px; color: var(--cyan); font-family: 'Orbitron'; font-size: 0.85rem;
            border-left: 3px solid var(--cyan);
        }

        .board { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        .cell {
            aspect-ratio: 1; background: rgba(255,255,255,0.03); border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.08); display: flex; align-items: center;
            justify-content: center; font-size: 3.5rem; font-family: 'Orbitron'; cursor: pointer;
            transition: 0.3s;
        }
        .cell:active { transform: scale(0.9); }
        .cell.x { color: var(--cyan); text-shadow: 0 0 20px var(--cyan); }
        .cell.o { color: var(--pink); text-shadow: 0 0 20px var(--pink); }
        .cell.winner { background: #fff !important; color: #000 !important; box-shadow: 0 0 30px #fff; }

        input {
            width: 100%; padding: 15px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.3); color: white; text-align: center; font-size: 1rem; margin-bottom: 15px;
        }
        .btn {
            width: 100%; padding: 15px; border-radius: 15px; border: none;
            background: var(--cyan); color: black; font-weight: 900; cursor: pointer; font-size: 1rem;
        }
        .hidden { display: none !important; }

        .shake { animation: shake 0.4s ease-in-out; }
        @keyframes shake { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    </style>
</head>
<body>

<div class="nebula"></div>

<div id="setup-screen" class="overlay">
    <h1>NEURON LINK</h1>
    <div class="id-display" onclick="copyID()">
        <p style="margin: 0 0 5px; font-size: 0.8rem;">ÙƒÙˆØ¯ Ø¬Ù‡Ø§Ø²Ùƒ (Ø§Ø¶ØºØ· Ù„Ù„Ù†Ø³Ø®):</p>
        <span id="my-id">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆÙ„ÙŠØ¯...</span>
    </div>
    <div style="width: 100%; max-width: 300px;">
        <input type="text" id="peer-id-input" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ ØµØ¯ÙŠÙ‚Ùƒ">
        <button class="btn" onclick="connectToFriend()">Ø±Ø¨Ø· ÙˆØ§ØªØµØ§Ù„</button>
    </div>
    <p style="margin-top: 20px; font-size: 0.7rem; color: #666;">Ø§Ø¨Ø¹Ø« Ø§Ù„ÙƒÙˆØ¯ Ù„ØµØ§Ø­Ø¨Ùƒ Ø¨Ø§Ø´ ÙŠØ¯Ø®Ù„ Ù…Ø¹Ø§Ùƒ</p>
</div>

<div class="card" id="game-card">
    <div class="status" id="game-status">> INITIALIZING...</div>
    <div class="board" id="board">
        <div class="cell" data-i="0"></div><div class="cell" data-i="1"></div><div class="cell" data-i="2"></div>
        <div class="cell" data-i="3"></div><div class="cell" data-i="4"></div><div class="cell" data-i="5"></div>
        <div class="cell" data-i="6"></div><div class="cell" data-i="7"></div><div class="cell" data-i="8"></div>
    </div>
    <button onclick="location.reload()" style="background:none; border:none; color:#555; margin-top:15px; cursor:pointer;">Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„</button>
</div>

<script>
    let peer = new Peer();
    let conn;
    let mySymbol = ""; 
    let board = Array(9).fill("");
    let turn = "X";
    let active = true;

    const statusText = document.getElementById('game-status');
    const myIdDisplay = document.getElementById('my-id');

    // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù€ ID
    peer.on('open', (id) => {
        myIdDisplay.innerText = id;
        statusText.innerText = "> READY FOR CONNECTION";
    });

    // Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯
    function copyID() {
        navigator.clipboard.writeText(myIdDisplay.innerText);
        alert("ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯! Ø§Ø¨Ø¹Ø«ÙˆØ§ Ù„ØµØ§Ø­Ø¨Ùƒ");
    }

    // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø§ØªØµØ§Ù„
    peer.on('connection', (connection) => {
        conn = connection;
        mySymbol = "X"; // Ø§Ù„Ù…Ø³ØªØ¶ÙŠÙ Ø¯Ø§Ø¦Ù…Ø§ X
        startOnlineGame();
    });

    // Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±
    function connectToFriend() {
        const friendId = document.getElementById('peer-id-input').value;
        if (!friendId) return alert("Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø£ÙˆÙ„Ø§Ù‹");
        
        conn = peer.connect(friendId);
        mySymbol = "O"; // Ø§Ù„Ø¶ÙŠÙ Ø¯Ø§Ø¦Ù…Ø§ O
        
        conn.on('open', () => {
            startOnlineGame();
        });
    }

    function startOnlineGame() {
        document.getElementById('setup-screen').classList.add('hidden');
        statusText.innerText = `Ø£Ù†Øª Ø§Ù„Ù„Ø§Ø¹Ø¨: ${mySymbol} | ${mySymbol === 'X' ? 'Ø¯ÙˆØ±Ùƒ' : 'Ø§Ù†ØªØ¸Ø± Ø§Ù„Ø®ØµÙ…'}`;
        
        conn.on('data', (data) => {
            if (data.type === 'move') {
                processMove(data.index, data.player);
            }
        });
    }

    document.querySelectorAll('.cell').forEach(cell => {
        cell.addEventListener('click', () => {
            const i = cell.dataset.i;
            if (board[i] || turn !== mySymbol || !active || !conn) return;

            processMove(i, mySymbol);
            conn.send({ type: 'move', index: i, player: mySymbol });
        });
    });

    function processMove(i, p) {
        board[i] = p;
        const cell = document.querySelector(`[data-i="${i}"]`);
        cell.innerText = p;
        cell.classList.add(p.toLowerCase());
        
        if (checkWin(p)) {
            endGame(p);
        } else if (!board.includes("")) {
            endGame("DRAW");
        } else {
            turn = (p === "X") ? "O" : "X";
            updateStatus();
        }
    }

    function updateStatus() {
        const isMyTurn = turn === mySymbol;
        statusText.innerText = isMyTurn ? `> Ø¯ÙˆØ±Ùƒ Ø§Ù„Ø¢Ù† (${mySymbol})` : `> Ø§Ù†ØªØ¸Ø± Ø§Ù„Ø®ØµÙ…... (${turn})`;
        statusText.style.color = turn === "X" ? "var(--cyan)" : "var(--pink)";
    }

    function checkWin(p) {
        const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
        return wins.some(w => {
            const isWin = w.every(idx => board[idx] === p);
            if (isWin) {
                w.forEach(idx => document.querySelector(`[data-i="${idx}"]`).classList.add('winner'));
                document.getElementById('game-card').classList.add('shake');
            }
            return isWin;
        });
    }

    function endGame(res) {
        active = false;
        if (res === "DRAW") {
            statusText.innerText = "> ØªØ¹Ø§Ø¯Ù„! Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„...";
        } else {
            statusText.innerText = res === mySymbol ? "> Ù…Ø¨Ø±ÙˆÙƒ! Ù„Ù‚Ø¯ Ø³Ø­Ù‚Øª Ø§Ù„Ø®ØµÙ… ğŸ˜" : "> Ù„Ù„Ø£Ø³Ù! Ø§Ù„Ø®ØµÙ… ÙØ§Ø² Ø¹Ù„ÙŠÙƒ ğŸ’€";
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        }
        setTimeout(() => location.reload(), 5000);
    }
</script>
</body>
</html>
